<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <title>MapLibre Canvas Labels</title>
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
    <script src="https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.js"></script>
    <link href="https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.css" rel="stylesheet" />
    <style>
        body {
            margin: 0;
            padding: 0;
        }

        #map {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 100%;
        }
    </style>
</head>

<body>
    <div id="map"></div>

    <canvas id='textCanvas' height=20></canvas>


    <script>
        var map = new maplibregl.Map({
            container: 'map',
            style: 'https://wipfli.github.io/swiss-map/style.json',
            hash: 'map',
            center: [73.413, 18.92],
            zoom: 7.88,
            attributionControl: false
        })
            .addControl(new maplibregl.AttributionControl({
                compact: true,
                customAttribution: '<a href="https://github.com/wipfli/maplibre-canvas-labels/">More Languages...</a>'
            }));

        var ctx = document.getElementById('textCanvas').getContext('2d', {willReadFrequently: true}); //Hidden canvas

        map.on('styleimagemissing', function (e) {

            var id = e.id; // id of the missing image
            console.log(id);

            // check if this missing icon is one this function can generate
            var prefix = 'label-';
            if (id.indexOf(prefix) !== 0) return;

            var text = id.slice(prefix.length);
            var fontSize = 20;
            ctx.font = `${fontSize}px sans`;
            ctx.canvas.width = ctx.measureText(text).width;
            ctx.canvas.height = 1.5 * fontSize;
            ctx.font = `${fontSize}px sans`;
            ctx.fillText(text, 0, fontSize);

            map.loadImage(
                ctx.canvas.toDataURL(),
                function (error, image) {
                    if (error) throw error;
                    map.addImage(id, image);
                });
        });

        var hash = window.location.hash.substr(1);

        var result = hash.split('&').reduce(function (res, item) {
            var parts = item.split('=');
            res[parts[0]] = parts[1];
            return res;
        }, {});

        var language = result.language ? result.language : 'hi';

        map.on('load', function() {
            map.addLayer({
                'id': 'points',
                'type': 'symbol',
                'source': 'qrank',
                'source-layer': 'qrank',
                'layout': {
                    'icon-image': ['concat', 'label-', ['get', `name:${language}`]]
                }
            });
        });
        

    </script>

</body>

</html>