<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <title>MapLibre Canvas Labels</title>
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
    <script src="https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.js"></script>
    <link href="https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.css" rel="stylesheet" />
    <style>
        body {
            margin: 0;
            padding: 0;
        }

        #map {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 100%;
        }
    </style>
</head>

<body>
    <div id="map"></div>

    <canvas id='textCanvas' height=20></canvas>


    <script type="module">
        import TinySDF from 'https://cdn.skypack.dev/@mapbox/tiny-sdf';

        var map = new maplibregl.Map({
            container: 'map',
            style: 'https://wipfli.github.io/swiss-map/style.json',
            hash: 'map',
            center: [73.413, 18.92],
            zoom: 7.88,
            attributionControl: false
        })
            .addControl(new maplibregl.AttributionControl({
                compact: true,
                customAttribution: '<a href="https://github.com/wipfli/maplibre-canvas-labels/">More Languages...</a>'
            }));

        var ctx = document.getElementById('textCanvas').getContext('2d', { willReadFrequently: true }); //Hidden canvas

        const tinySdf = new TinySDF({
            fontSize: 18,             // Font size in pixels
            fontFamily: 'sans-serif', // CSS font-family
            fontWeight: 'normal',     // CSS font-weight
            fontStyle: 'normal',      // CSS font-style
            buffer: 30,                // Whitespace buffer around a glyph in pixels
            radius: 8,                // How many pixels around the glyph shape to use for encoding distance
            cutoff: 0.25              // How much of the radius (relative) is used for the inside part of the glyph
        });

        map.on('styleimagemissing', function (e) {

            var id = e.id; // id of the missing image
            console.log(id);

            // check if this missing icon is one this function can generate
            var prefix = 'label-';
            if (id.indexOf(prefix) !== 0) return;
            if (id.length === prefix.length) return;

            var text = id.slice(prefix.length);

            const glyph = tinySdf.draw(text);
            var data = new Uint8Array(glyph.width * glyph.height * 4);
            for (var i = 0; i < glyph.width * glyph.height; ++i) {
                data[4 * i + 0] = 0;
                data[4 * i + 1] = 0;
                data[4 * i + 2] = 0;
                data[4 * i + 3] = glyph.data[i];
            }
            map.addImage(id,
                {
                    data,
                    width: glyph.width,
                    height: glyph.height
                },
                {
                    sdf: true
                }
            )
        });

        var hash = window.location.hash.substr(1);

        var result = hash.split('&').reduce(function (res, item) {
            var parts = item.split('=');
            res[parts[0]] = parts[1];
            return res;
        }, {});

        var language = result.language ? result.language : 'hi';

        map.on('load', function () {
            map.addLayer({
                'id': 'points',
                'type': 'symbol',
                'source': 'qrank',
                'source-layer': 'qrank',
                'layout': {
                    'icon-image': ['concat', 'label-', ['get', `name:${language}`]]
                },
                'paint': {
                    "icon-halo-color": "white",
                    'icon-halo-width': 1.5
                }
            });
        });

    </script>

</body>

</html>